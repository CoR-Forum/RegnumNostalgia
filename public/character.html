<!-- Character Window (equipment + stats) -->
<div id="character-window" class="ui-window" style="position: absolute; left: 12px; bottom: 195px; width: 240px; max-height: 85vh; overflow-y: auto; overflow-x: hidden; z-index: 1000; display: none; flex-direction: column; font-family: 'MS Sans Serif', Arial, sans-serif;">
  <div id="character-header" class="ui-window-titlebar" style="cursor: move; display: flex; justify-content: space-between; align-items: center; user-select: none;">
    <h2 style="margin: 0; flex: 1; font-size: 11px; font-weight: 700; color: #ffffff; text-align: center;">Character</h2>
    <button id="character-close-btn" class="ui-window-close-btn"></button>
  </div>

  <div id="character-body" class="ui-window-body" style="padding: 8px; display: flex; flex-direction: column; gap: 6px;">
    <div class="char-section" style="padding-top:10px;">
      <div class="char-section-title">Name</div>
      <div class="char-section-body">
        <div id="char-name" class="char-line">-</div>
        <div id="char-realm" class="char-line">-</div>
        <div id="char-class" class="char-line">-</div>
        <div class="char-line">Level <span id="char-level">1</span></div>
      </div>
    </div>

    <div class="char-section">
      <div class="char-section-title">Experience</div>
      <div class="char-section-body">
        <div id="char-xp-text" class="char-line">0 / 0</div>
        <div class="char-xp-bar">
          <div id="char-xp-fill"></div>
        </div>
        <div id="char-rp" class="char-line">0 Regnum Points</div>
      </div>
    </div>

    <!-- Attributes moved below Attack/Armor for compact view -->

    <div class="char-section">
      <div class="char-section-title">Stats</div>
      <div class="char-section-body char-stats-grid">
          <div class="char-stats-block">
            <div style="font-weight:700;margin-bottom:4px;">Stats</div>
            <div class="char-stat-row"><span>Attack:</span><span id="stat-attack">0</span></div>
            <div class="char-stat-row"><span>Armor:</span><span id="stat-armor">0</span></div>
            <div class="char-stat-row"><span>Hit Chance:</span><span id="stat-hit">0</span></div>
            <div class="char-stat-row"><span>Evasion:</span><span id="stat-evasion">0</span></div>
            <div class="char-stat-row"><span>Block Chance:</span><span id="stat-block">0</span></div>
          </div>

          <div class="char-stats-block">
            <div style="font-weight:700;margin-bottom:4px;">Damage Types</div>
            <div class="char-stat-row"><span>Lightning:</span><span id="stat-damage-lightning">0</span></div>
            <div class="char-stat-row"><span>Fire:</span><span id="stat-damage-fire">0</span></div>
            <div class="char-stat-row"><span>Ice:</span><span id="stat-damage-ice">0</span></div>
            <div class="char-stat-row"><span>pierce:</span><span id="stat-damage-pierce">0</span></div>
            <div class="char-stat-row"><span>Blunt:</span><span id="stat-damage-blunt">0</span></div>
            <div class="char-stat-row"><span>slash:</span><span id="stat-damage-slash">0</span></div>
          </div>

          <div class="char-stats-block">
            <div style="height:6px"></div>
            <div style="font-weight:700;margin-bottom:4px;">Attributes</div>
            <div class="char-stat-row"><span>Intelligence:</span><span id="stat-int">20</span></div>
            <div class="char-stat-row"><span>Dexterity:</span><span id="stat-dex">20</span></div>
            <div class="char-stat-row"><span>Concentration:</span><span id="stat-con">20</span></div>
            <div class="char-stat-row"><span>Strength:</span><span id="stat-str">20</span></div>
            <div class="char-stat-row"><span>Constitution:</span><span id="stat-const">20</span></div>
          </div>

          <div class="char-stats-block">
            <div style="height:6px"></div>
            <div style="font-weight:700;margin-bottom:4px;">Armor Types</div>
            <div class="char-stat-row"><span>Lightning:</span><span id="stat-armor-lightning">0</span></div>
            <div class="char-stat-row"><span>Fire:</span><span id="stat-armor-fire">0</span></div>
            <div class="char-stat-row"><span>Ice:</span><span id="stat-armor-ice">0</span></div>
            <div class="char-stat-row"><span>pierce:</span><span id="stat-armor-pierce">0</span></div>
            <div class="char-stat-row"><span>Blunt:</span><span id="stat-armor-blunt">0</span></div>
            <div class="char-stat-row"><span>slash:</span><span id="stat-armor-slash">0</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="char-section">
      <div class="char-section-body char-status">
        <span>Weakness of the Dead</span><span id="stat-weakness">0%</span>
      </div>
    </div>
  </div>
</div>

<style>
  /* Equipment slot visuals (moved from index.html) */
  .equipment-slot.empty{ opacity:0.45; }
  .equipment-slot .slot-icon{ font-size:22px; }
  .equipment-slot .slot-rarity-border{ inset: -2px; border-radius:4px; }
  .equipment-slot.drag-over{ outline: 2px dashed #0d6efd; }
  /* Equipment slot background icons */
  .equipment-slot[data-slot="head"].empty{ background-image: url('https://cor-forum.de/regnum/RegnumNostalgia/ui/ui-equip-slot-head.png'); }
  .equipment-slot[data-slot="body"].empty{ background-image: url('https://cor-forum.de/regnum/RegnumNostalgia/ui/ui-equip-slot-torso.png'); }
  .equipment-slot[data-slot="hands"].empty{ background-image: url('https://cor-forum.de/regnum/RegnumNostalgia/ui/ui-equip-slot-arms.png'); }
  .equipment-slot[data-slot="shoulders"].empty{ background-image: url('https://cor-forum.de/regnum/RegnumNostalgia/ui/ui-equip-slot-pauldron.png'); }
  .equipment-slot[data-slot="legs"].empty{ background-image: url('https://cor-forum.de/regnum/RegnumNostalgia/ui/ui-equip-slot-legs.png'); }
  .equipment-slot[data-slot="weaponRight"].empty{ background-image: url('https://cor-forum.de/regnum/RegnumNostalgia/ui/ui-equip-slot-hand-right.png'); }
  .equipment-slot[data-slot="weaponLeft"].empty{ background-image: url('https://cor-forum.de/regnum/RegnumNostalgia/ui/ui-equip-slot-hand-left.png'); }
  .equipment-slot[data-slot="ringRight"].empty{ background-image: url('https://cor-forum.de/regnum/RegnumNostalgia/ui/ui-equip-slot-rings.png'); }
  .equipment-slot[data-slot="ringLeft"].empty{ background-image: url('https://cor-forum.de/regnum/RegnumNostalgia/ui/ui-equip-slot-rings.png'); }
  .equipment-slot[data-slot="amulet"].empty{ background-image: url('https://cor-forum.de/regnum/RegnumNostalgia/ui/ui-equip-slot-amulet.png'); }

  /* Character window (classic layout) */
  .char-section{ border: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.25); }
  .char-section + .char-section{ margin-top: 4px; }
  .char-section-title{
    padding: 4px 6px;
    font-size: 11px;
    font-weight: 700;
    text-align: center;
    color: #e0e0e0;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    background: rgba(0,0,0,0.35);
  }
  .char-section-body{ padding: 6px; font-size: 12px; color: #e0e0e0; }
  .char-line{ margin: 2px 0; }
  .char-xp-bar{ height: 8px; border: 1px solid rgba(255,255,255,0.25); background: rgba(0,0,0,0.4); margin: 6px 0; }
  #char-xp-fill{ height: 100%; width: 0%; background: linear-gradient(90deg,#2dd4bf,#60a5fa); }
  .char-attr-row{ display:flex; justify-content:space-between; gap: 8px; margin: 2px 0; }
  .char-attr-name{ flex: 1; color: #ffffff; }
  .char-attr-name.char-attr-good,
  .char-attr-name.char-attr-bad{ color: #ffffff; }
  .char-attr-value{ min-width: 40px; text-align: right; }
  .char-attr-value{ color: #ffffff; }
  .char-attr-good{ color: #22c55e; }
  .char-attr-bad{ color: #ef4444; }
  .char-attributes-grid{ display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
  .attr-col{ display:flex; flex-direction:column; gap:4px; }
  .char-stats-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  .char-stats-col{ width:100%; box-sizing:border-box; }
  .char-stat-row{ display:flex; justify-content:space-between; gap:8px; margin:2px 0; font-size:11px; }
</style>

<script>
  // Character window helpers remain; opening is handled by `openWindow()` in index.html.

  function updateCharacterStats(){
    try{
      const lvlEl = document.getElementById('char-level'); if (lvlEl) lvlEl.textContent = gameState.level || 1;
      const nameEl = document.getElementById('char-name'); if (nameEl) nameEl.textContent = gameState.username || '-';
      const realmEl = document.getElementById('char-realm');
      if (realmEl) {
        const realm = gameState.realm ? (String(gameState.realm).charAt(0).toUpperCase() + String(gameState.realm).slice(1)) : '-';
        realmEl.textContent = realm;
      }
      const classEl = document.getElementById('char-class');
      if (classEl) classEl.textContent = gameState.className || gameState.class || 'Unknown';
      try {
        const fill = document.getElementById('char-xp-fill');
        const xp = Number(gameState.xp || 0);
        const xpToNextVal = Number(gameState.xpToNext || 0);
        const pct = (xpToNextVal > 0) ? Math.round((xp / (xp + xpToNextVal)) * 100) : 100;
        if (fill) fill.style.width = pct + '%';
        const xpText = document.getElementById('char-xp-text');
        if (xpText) xpText.textContent = `${xp} / ${xp + xpToNextVal}`;
        const rpEl = document.getElementById('char-rp');
        const rpVal = Number(gameState.regnumPoints || 0);
        if (rpEl) rpEl.textContent = `${rpVal} Regnum Points`;
      } catch (e) {}
      const s = gameState.stats || { intelligence:20, dexterity:20, concentration:20, strength:20, constitution:20 };
      document.getElementById('stat-int').textContent = `${s.intelligence || 20}`;
      document.getElementById('stat-dex').textContent = `${s.dexterity || 20}`;
      document.getElementById('stat-con').textContent = `${s.concentration || 20}`;
      document.getElementById('stat-str').textContent = `${s.strength || 20}`;
      document.getElementById('stat-const').textContent = `${s.constitution || 20}`;
      try {
        const dmg = Number(gameState.damage || 0);
        const arm = Number(gameState.armor || 0);
        const dmgEl = document.getElementById('stat-attack');
        const armEl = document.getElementById('stat-armor');
        if (dmgEl) dmgEl.textContent = `${dmg}`;
        if (armEl) armEl.textContent = `${arm}`;
        const hitEl = document.getElementById('stat-hit');
        const evasionEl = document.getElementById('stat-evasion');
        const blockEl = document.getElementById('stat-block');
        if (hitEl) hitEl.textContent = `${Number(gameState.hitChance || 0)}`;
        if (evasionEl) evasionEl.textContent = `${Number(gameState.evasion || 0)}`;
        if (blockEl) blockEl.textContent = `${Number(gameState.blockChance || 0)}`;
        const weaknessEl = document.getElementById('stat-weakness');
        if (weaknessEl) weaknessEl.textContent = `${Number(gameState.weakness || 0)}%`;

        // Damage type breakdown: use structured `damageTypes` / `armorTypes`.
        // Fallback: accept older nested `damage` / `armor` objects (but no flattened keys).
        const dt = gameState.damageTypes || gameState.damage || {};
        const at = gameState.armorTypes || gameState.armor || {};

        const dl = Number(dt.lightning || 0);
        const df = Number(dt.fire || 0);
        const di = Number(dt.ice || 0);
        const dp = Number(dt.pierce || 0);
        const db = Number(dt.blunt || 0);
        const ds = Number(dt.slash || 0);

        const al = Number(at.lightning || 0);
        const af = Number(at.fire || 0);
        const ai = Number(at.ice || 0);
        const ap = Number(at.pierce || 0);
        const ab = Number(at.blunt || 0);
        const as_ = Number(at.slash || 0);

        const setIf = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = `${Number(val || 0)}`; };
        setIf('stat-damage-lightning', dl);
        setIf('stat-damage-fire', df);
        setIf('stat-damage-ice', di);
        setIf('stat-damage-pierce', dp);
        setIf('stat-damage-blunt', db);
        setIf('stat-damage-slash', ds);

        setIf('stat-armor-lightning', al);
        setIf('stat-armor-fire', af);
        setIf('stat-armor-ice', ai);
        setIf('stat-armor-pierce', ap);
        setIf('stat-armor-blunt', ab);
        setIf('stat-armor-slash', as_);
      } catch (e) {}
    }catch(e){}
  }

  function getEquipIconSrc(item){
    const iconName = item.iconName;
    return iconName ? `https://cor-forum.de/regnum/RegnumNostalgia/items/${iconName}` : '';
  }

  function getItemTypeLabel(item){
    const slot = item.equipmentSlot || null;
    if(slot){
      switch(slot){
        case 'head': return 'Armor (Head)';
        case 'body': return 'Armor (Body)';
        case 'hands': return 'Armor (Hands)';
        case 'shoulders': return 'Armor (Shoulders)';
        case 'legs': return 'Armor (Legs)';
        case 'weaponRight': return 'Weapon (Right Hand)';
        case 'weaponLeft': return 'Weapon (Left Hand)';
        case 'ringRight':
        case 'ringLeft': return 'Ring';
        case 'amulet': return 'Amulet';
        default: return item.itemType || '';
      }
    }
    const t = item.itemType || '';
    return t.charAt(0).toUpperCase() + t.slice(1);
  }

  async function displayEquipment(equipment){
    try{
      const slots = ['head','body','hands','shoulders','legs','weaponRight','weaponLeft','ringRight','ringLeft','amulet'];
      slots.forEach(slot => {
        const el = document.querySelector(`.equipment-slot[data-slot="${slot}"]`);
        if(!el) return;
        const info = equipment[slot] || { inventoryId: null, item: null };
        el.classList.toggle('empty', !info || !info.inventoryId);
        el.dataset.slot = slot;
        const newEl = el.cloneNode(true);
        el.parentNode.replaceChild(newEl, el);
        const target = newEl;

          if(info && info.inventoryId){
          const it = info.item || {};
          const iconSrc = getEquipIconSrc(it || {});
          target.innerHTML = iconSrc ? `<div class="slot-icon"><img src="${iconSrc}" alt="${it.name || it.itemName || 'Item'}"></div>` : '';
          target.dataset.inventoryId = info.inventoryId;
          target.addEventListener('mouseenter', (e)=>{
            const tooltipItem = {
              itemName: it.name || it.itemName || '',
              itemType: it.type || it.itemType || '',
                equipmentSlot: it.equipmentSlot || null,
              description: it.description || '',
              stats: it.stats || {},
              rarity: it.rarity || 'common',
              quantity: it.quantity || 1,
                level: typeof it.level !== 'undefined' ? it.level : 1,
                iconName: it.iconName || null,
                inventoryId: info.inventoryId || null
            };
            showTooltip(e, tooltipItem);
          });
          target.addEventListener('mousemove', moveTooltip);
          target.addEventListener('mouseleave', hideTooltip);

          target.draggable = true;
          target.addEventListener('dragstart', (ev) => {
            const payload = JSON.stringify({ fromSlot: true, slot: slot, inventoryId: info.inventoryId });
            try{ ev.dataTransfer.setData('application/json', payload); }catch(_){ ev.dataTransfer.setData('text/plain', payload); }
          });

          target.addEventListener('contextmenu', async (e) => {
            try {
              e.preventDefault();
              const form = new URLSearchParams();
              form.append('slot', slot);
              try {
                await emitOrApi('equipment:unequip', { slot }, '/equipment/unequip', form);
              } catch (err) {
                const msg = (err && err.body && err.body.error) ? err.body.error : (err && err.message) ? err.message : 'Failed to unequip item';
                if (window.addLogMessage) window.addLogMessage(msg, 'error');
              }
              try { if (document.getElementById('inventory-window') && document.getElementById('inventory-window').style.display !== 'none') await openWindow('inventory-window'); } catch(e){}
              try { if (document.getElementById('character-window') && document.getElementById('character-window').style.display !== 'none') await openWindow('character-window'); } catch(e){}
            } catch (e) { console.error('equipment right-click unequip failed', e); }
          });
        } else {
          target.innerHTML = '';
          target.removeAttribute('data-inventory-id');
          target.draggable = false;
          target.addEventListener('mouseenter', ()=>{});
        }

        target.addEventListener('dragover', (e)=>{ e.preventDefault(); target.classList.add('drag-over'); });
        target.addEventListener('dragleave', ()=>{ target.classList.remove('drag-over'); });
        target.addEventListener('drop', async (e)=>{
          e.preventDefault(); target.classList.remove('drag-over');
          try{
            const payload = e.dataTransfer.getData('application/json') || e.dataTransfer.getData('text/plain');
            if(!payload) return;
            const data = JSON.parse(payload);
            if(data.inventoryId){
              const form = new URLSearchParams();
              form.append('inventoryId', data.inventoryId);
              try {
                await emitOrApi('equipment:equip', { inventoryId: data.inventoryId }, '/equipment/equip', form);
              } catch (err) {
                try {
                  const msg = (err && err.body && err.body.error) ? err.body.error : (err && err.message) ? err.message : 'Failed to equip item';
                  if (window.addLogMessage) window.addLogMessage(msg, 'error');
                } catch (e) { console.error('Failed to log equip error', e); }
              }
              try { if (document.getElementById('character-window') && document.getElementById('character-window').style.display !== 'none') { await openWindow('character-window'); } } catch(e){}
              try { if (document.getElementById('inventory-window') && document.getElementById('inventory-window').style.display !== 'none') { await openWindow('inventory-window'); } } catch(e){}
            }
          }catch(err){ console.error('Equip failed', err); }
        });
      });
    }catch(err){ console.error('displayEquipment error', err); }
  }
</script>
