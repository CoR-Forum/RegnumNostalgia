<!-- Login/Realm Selection Modal -->
<div id="modal-overlay">
  <div class="modal-content ui-window">
    <div class="modal-logo" style="text-align:center;padding-bottom:8px;pointer-events:none;">
      <img src="assets/regnum-nostalgia-logo.png" alt="Regnum Nostalgia" style="max-width:240px;height:auto;display:inline-block;">
    </div>
    <!-- Step 1: Login -->
    <div id="step-login" class="modal-step active">
      <div class="modal-title ui-window-titlebar">
        <h2 style="margin: 0; flex: 1; font-size: 11px; font-weight: 700; color: #ffffff; font-family: 'MS Sans Serif', Arial, sans-serif; text-align: center;">Regnum Nostalgia - Login</h2>
      </div>
      <div class="modal-body ui-window-body">
        <div style="color:#e0e0e0;margin-bottom:12px;font-size:11px;text-align:center;padding-top:12px;">
      Login with your cor-forum.de account
        </div>
        <div id="auto-login-loading" class="hidden" style="text-align:center;padding:20px;color:#e0e0e0;font-size:11px;">
          <div class="loading-spinner" style="display:inline-block;margin-bottom:8px;"></div>
          <div>Checking session...</div>
        </div>
        <div id="login-error" class="error-message hidden"></div>
        <form id="login-form">
      <div class="form-group">
        <label class="form-label" for="username">Username</label>
        <input type="text" id="username" class="form-input" placeholder="Enter your cor-forum.de username" required>
      </div>
      <div class="form-group">
        <label class="form-label" for="password">Password</label>
        <input type="password" id="password" class="form-input" placeholder="Enter your password" required>
      </div>
      <button type="submit" id="login-btn" class="btn btn-primary">
        <span id="login-text">Login</span>
        <span id="login-spinner" class="loading-spinner" style="display:none;"></span>
      </button>
        </form>
        <p style="margin-top:8px;font-size:11px;color:#e0e0e0;text-align:center;">
      <a href="https://cor-forum.de/board/register/" target="_blank" rel="noopener noreferrer" style="color:#00d9ff;text-decoration:underline;">Sign up</a>&nbsp;&nbsp;<a href="https://cor-forum.de/board/lost-password/" target="_blank" rel="noopener noreferrer" style="color:#00d9ff;text-decoration:underline;">Reset password</a>
        </p>
      </div>
    </div>
    

    <!-- Step 2: Realm Selection -->
    <div id="step-realm" class="modal-step">
      <div class="modal-title ui-window-titlebar">
        <h2 style="margin: 0; flex: 1; font-size: 11px; font-weight: 700; color: #ffffff; font-family: 'MS Sans Serif', Arial, sans-serif; text-align: center;">Regnum Nostalgia - Select Realm</h2>
      </div>
      <div class="modal-body ui-window-body">
        <p style="color:#e0e0e0;text-align:center;margin-bottom:8px;font-size:11px;">You may change your realm later</p>
        <div id="realm-error" class="error-message hidden"></div>
        <div class="realm-cards">
          <div class="realm-card syrtis" data-realm="syrtis">
            <div class="realm-icon"><img src="assets/logo-syrtis.webp" alt="Syrtis"></div>
            <div class="realm-info">
              <h3>Syrtis</h3>
              <p>The Elven Kingdom</p>
            </div>
          </div>
          <div class="realm-card alsius" data-realm="alsius">
            <div class="realm-icon"><img src="assets/logo-alsius.webp" alt="Alsius"></div>
            <div class="realm-info">
              <h3>Alsius</h3>
              <p>The Dwarven Realm</p>
            </div>
          </div>
          <div class="realm-card ignis" data-realm="ignis">
            <div class="realm-icon"><img src="assets/logo-ignis.webp" alt="Ignis"></div>
            <div class="realm-info">
              <h3>Ignis</h3>
              <p>The Human Empire</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // Wait for gameState and required functions to be available
  function initLoginHandlers() {
    if (typeof window.gameState === 'undefined' || typeof window.apiCall === 'undefined' || typeof window.initGame === 'undefined') {
      setTimeout(initLoginHandlers, 50);
      return;
    }

    const gameState = window.gameState;
    const apiCall = window.apiCall;
    const initGame = window.initGame;

    // Login form submit handler
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const loginBtn = document.getElementById('login-btn');
      const loginText = document.getElementById('login-text');
      const loginSpinner = document.getElementById('login-spinner');
      const errorEl = document.getElementById('login-error');

      loginBtn.disabled = true;
      loginText.style.display = 'none';
      loginSpinner.style.display = 'inline-block';
      errorEl.classList.add('hidden');

      try {
        const formData = new URLSearchParams();
        formData.append('username', username);
        formData.append('password', password);

        const data = await apiCall('/login', {
          method: 'POST',
          body: formData,
          skipAuth: true
        });

        if (!data || !data.sessionToken) {
          throw new Error((data && data.error) ? data.error : 'Login failed: missing session token');
        }

        gameState.sessionToken = data.sessionToken;
        gameState.userId = data.userId;
        gameState.username = data.username;
        gameState.realm = data.realm;

        try { 
          localStorage.setItem('sessionToken', data.sessionToken); 
        } catch (e) {
          console.error('[Session] Failed to store token in localStorage:', e);
        }

        if (data.needsRealmSelection) {
          showRealmSelection();
        } else {
          await initGame();
        }
      } catch (error) {
        errorEl.textContent = error.message;
        errorEl.classList.remove('hidden');
        loginBtn.disabled = false;
        loginText.style.display = 'inline';
        loginSpinner.style.display = 'none';
      }
    });

    // Realm selection handler
    document.querySelectorAll('.realm-card').forEach(card => {
      card.addEventListener('click', async () => {
        const realm = card.dataset.realm;
        const errorEl = document.getElementById('realm-error');
        errorEl.classList.add('hidden');

        try {
          const formData = new URLSearchParams();
          formData.append('realm', realm);

          const data = await apiCall('/realm/select', {
            method: 'POST',
            body: formData
          });

          gameState.realm = data.realm;
          gameState.position = data.position;

          await initGame();
        } catch (error) {
          errorEl.textContent = error.message;
          errorEl.classList.remove('hidden');
        }
      });
    });
  }

  // Realm selection function exposed globally
  window.showRealmSelection = function() {
    document.getElementById('step-login').classList.remove('active');
    document.getElementById('step-realm').classList.add('active');
  };

  // Hide modal function exposed globally
  window.hideModal = function() {
    const overlay = document.getElementById('modal-overlay');
    overlay.classList.add('hidden');
    // restore overlay pointer behavior
    try { overlay.style.pointerEvents = 'auto'; } catch (e) {}
    // leave build mode off when modal hidden
    try { if (window.gameState) window.gameState.buildPathMode = false; } catch (e) {}
    // clear any inline styles applied to build modal step
    try {
      const step = document.getElementById('step-build-path');
      if (step) {
        step.style.position = '';
        step.style.left = '';
        step.style.top = '';
        step.style.zIndex = '';
        step.style.pointerEvents = '';
        step.style.maxWidth = '';
      }
    } catch (e) {}
  };

  // Show modal function exposed globally
  window.showModal = function() {
    const overlay = document.getElementById('modal-overlay');
    if (overlay) overlay.classList.remove('hidden');
  };

  // Initialize login handlers
  initLoginHandlers();
})();
</script>
