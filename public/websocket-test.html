<!DOCTYPE html>
<html>
<head>
  <title>WebSocket Connection Test</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 { color: #60a5fa; }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    .connected { background: #065f46; color: #10b981; }
    .disconnected { background: #7f1d1d; color: #ef4444; }
    .connecting { background: #78350f; color: #f59e0b; }
    .log {
      background: #0a0a0a;
      border: 1px solid #333;
      padding: 10px;
      height: 400px;
      overflow-y: auto;
      font-size: 12px;
      margin: 10px 0;
    }
    .log-entry {
      padding: 2px 0;
      border-bottom: 1px solid #222;
    }
    .log-time { color: #666; }
    .log-event { color: #60a5fa; font-weight: bold; }
    .log-data { color: #a0a0a0; }
    button {
      background: #1e40af;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 5px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover { background: #1e3a8a; }
    button:disabled { background: #374151; cursor: not-allowed; }
    input {
      background: #0a0a0a;
      border: 1px solid #333;
      color: #e0e0e0;
      padding: 8px;
      width: 300px;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>ðŸ”Œ WebSocket Connection Test</h1>
  
  <div id="status" class="status disconnected">DISCONNECTED</div>
  
  <div>
    <h3>Authentication</h3>
    <input type="text" id="token" placeholder="JWT Token (from localStorage)" />
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
  </div>
  
  <div>
    <h3>Test Events</h3>
    <button onclick="testMove()" id="testMoveBtn" disabled>Test Move Request</button>
    <button onclick="testChat()" id="testChatBtn" disabled>Test Chat Message</button>
    <button onclick="clearLog()">Clear Log</button>
  </div>
  
  <div>
    <h3>Event Log</h3>
    <div id="log" class="log"></div>
  </div>
  
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    let socket = null;
    
    function log(event, data) {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-event">${event}</span> <span class="log-data">${JSON.stringify(data, null, 2)}</span>`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function updateStatus(status, className) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = status;
      statusDiv.className = `status ${className}`;
    }
    
    function enableTestButtons(enabled) {
      document.getElementById('testMoveBtn').disabled = !enabled;
      document.getElementById('testChatBtn').disabled = !enabled;
    }
    
    function connect() {
      if (socket && socket.connected) {
        log('INFO', 'Already connected');
        return;
      }
      
      const token = document.getElementById('token').value.trim() || localStorage.getItem('sessionToken');
      if (!token) {
        alert('Please enter a JWT token or login first to populate localStorage');
        return;
      }
      
      document.getElementById('token').value = token;
      updateStatus('CONNECTING...', 'connecting');
      log('CONNECT', { token: token.substring(0, 20) + '...' });
      
      socket = io({
        auth: { token },
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        reconnectionAttempts: 5
      });
      
      socket.on('connect', () => {
        updateStatus('CONNECTED', 'connected');
        enableTestButtons(true);
        log('connect', { id: socket.id });
      });
      
      socket.on('disconnect', (reason) => {
        updateStatus('DISCONNECTED', 'disconnected');
        enableTestButtons(false);
        log('disconnect', { reason });
      });
      
      socket.on('connect_error', (error) => {
        updateStatus('CONNECTION ERROR', 'disconnected');
        log('connect_error', { message: error.message });
      });
      
      socket.on('error', (data) => {
        log('error', data);
      });
      
      // Player events
      socket.on('player:state', (data) => log('player:state', data));
      socket.on('players:online', (data) => log('players:online', { count: data.players?.length || 0 }));
      socket.on('player:connected', (data) => log('player:connected', data));
      socket.on('player:disconnected', (data) => log('player:disconnected', data));
      
      // Walker events
      socket.on('walker:step', (data) => log('walker:step', data));
      socket.on('walker:completed', (data) => log('walker:completed', data));
      socket.on('move:started', (data) => log('move:started', data));
      
      // Territory events
      socket.on('territories:list', (data) => log('territories:list', { count: data.territories?.length || 0 }));
      socket.on('territories:update', (data) => log('territories:update', data));
      socket.on('territories:capture', (data) => log('territories:capture', data));
      
      // Superboss events
      socket.on('superbosses:list', (data) => log('superbosses:list', { count: data.superbosses?.length || 0 }));
      socket.on('superbosses:health', (data) => log('superbosses:health', data));
      
      // Time events
      socket.on('time:current', (data) => log('time:current', data));
      socket.on('time:update', (data) => log('time:update', data));
      
      // Shoutbox events
      socket.on('shoutbox:message', (data) => log('shoutbox:message', data));
    }
    
    function disconnect() {
      if (socket) {
        socket.disconnect();
        socket = null;
      }
    }
    
    function testMove() {
      if (!socket || !socket.connected) {
        alert('Not connected');
        return;
      }
      
      const moveData = {
        x: Math.floor(Math.random() * 6144),
        y: Math.floor(Math.random() * 6144)
      };
      
      log('EMIT move:request', moveData);
      socket.emit('move:request', moveData);
    }
    
    function testChat() {
      if (!socket || !socket.connected) {
        alert('Not connected');
        return;
      }
      
      const message = `Test message at ${new Date().toLocaleTimeString()}`;
      log('EMIT shoutbox:send', { message });
      
      socket.emit('shoutbox:send', { message }, (response) => {
        log('shoutbox:send RESPONSE', response);
      });
    }
    
    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }
    
    // Auto-populate token from localStorage if available
    window.addEventListener('load', () => {
      const token = localStorage.getItem('sessionToken');
      if (token) {
        document.getElementById('token').value = token;
        log('INFO', 'Token loaded from localStorage');
      }
    });
  </script>
</body>
</html>
